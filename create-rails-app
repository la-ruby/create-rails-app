#!/bin/bash

set -e  # fail early
set -u  # warn about empty variables
set -x  # debug mode (during development)

# Variables
export CRA_ROOT="${HOME}/.cra"
export CRA_RAILS_VERSION="6-0-stable"

# Some working directories
mkdir -p ${HOME}/.cra
mkdir -p ${HOME}/.cra/rails

# Download some functions
(cd ${CRA_ROOT} && curl -sO https://raw.githubusercontent.com/la-ruby/insist-on-latest-ruby/master/insist_on_latest_ruby)
source ${CRA_ROOT}/insist_on_latest_ruby

# function to be run in any case
cra_cleanup() {
    rm -rf $CRA_ROOT
}

insist_on_latest_ruby

git clone -b $CRA_RAILS_VERSION --single-branch https://github.com/rails/rails ${CRA_ROOT}/rails
(cd ${CRA_ROOT}/rails && bundle update --bundler)
(cd ${CRA_ROOT}/rails && bundle install)
(cd ${CRA_ROOT}/rails/railties/exe && bundle exec rails --version)
(cd ${CRA_ROOT}/rails/railties/exe && bundle exec rails new ${CRA_ROOT}/common-core --dev --database=postgresql --force)
(cd ${CRA_ROOT}/common-core/ && bundle exec rails --version)

# Housekeeping
trap cra_cleanup EXIT
