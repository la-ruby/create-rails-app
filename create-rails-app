#!/bin/bash

RAILS_VERSION="7-0-stable"
BOOTSTRAP_VERSION="5.1"
SCRIPT_DIR=$(dirname "$0")

cat $SCRIPT_DIR/templates/app/views/_flashie.html.erb

download() {
  git clone -b 7-0-stable --single-branch https://github.com/rails/rails /tmp/rails
}

generate() {
  cd /tmp/rails
  bundle install &>/dev/null
  bundle exec railties/exe/rails new /tmp/created-rails-app --dev --database=postgresql >/dev/null
  cd /tmp/created-rails-app
  commit "Did generate()"
}

# repoint gemfile to github rails/rails
repoint() {
  cd /tmp/created-rails-app
  sed -i "/^gem \"rails/c\REMOVED" Gemfile # remove line
  replacement="gem 'rails', :github => 'rails/rails', :branch => '7-0-stable'"
  sed -i "/^REMOVED/c\\$replacement" Gemfile # add back line
  rm Gemfile.lock
  bundle install &>/dev/null
  bundle lock --add-platform ruby # this was needed because ci runs in linux
  ./bin/setup
  commit "Did repoint()"
}

# adds devise gem
devise() {
  cd /tmp/created-rails-app
  bundle add devise --git "https://github.com/heartcombo/devise" --branch "main" &>/dev/null
  bundle install &>/dev/null
  ./bin/rails generate devise:install
  ./bin/rails generate devise User
  ./bin/rails db:migrate
  sed -i -e 's/^/# /' test/fixtures/users.yml # stackoverflow/a/51102255

  commit "Did devise()"
}

bootstrap() {
    cd /tmp/created-rails-app

    (cd /tmp/ && curl -s -O https://getbootstrap.com/docs/5.1/examples/sign-in/signin.css)
    sed -i 's/body/.bootstrap-signin-example-wrapper/g' /tmp/signin.css

    (cd /tmp/ && curl -s -O https://raw.githubusercontent.com/twbs/bootstrap/main/site/content/docs/5.1/examples/sign-in/index.html)
    mkdir -p app/views/devise/sessions
    cp /tmp/index.html app/views/devise/sessions/new.html.erb
    sed -i 1,9d app/views/devise/sessions/new.html.erb
    sed -i '1s/^/<div class="bootstrap-signin-example-wrapper text-center">\n/' app/views/devise/sessions/new.html.erb
    sed -i -e '$a</div>' app/views/devise/sessions/new.html.erb
    sed -i 's/{{< year >}}/2022/g' app/views/devise/sessions/new.html.erb


    myvar='<img class="mb-4" src="https://getbootstrap.com/docs/5.1/assets/brand/bootstrap-logo.svg" alt="" width="72" height="57">'
    sed -i "s@.*bootstrap-logo.svg.*@$myvar@" app/views/devise/sessions/new.html.erb
    echo '<style>' >> app/views/devise/sessions/new.html.erb
    cat /tmp/signin.css >> app/views/devise/sessions/new.html.erb
    echo '</style>' >> app/views/devise/sessions/new.html.erb

    cd /tmp/
    git clone git@github.com:la-ruby/bootstrap.git
    cd /tmp/bootstrap
    npm install
    npm run dist
    cp dist/js/bootstrap.bundle.js.map /tmp/created-rails-app/public/
    cp dist/js/bootstrap.bundle.js /tmp/created-rails-app/public/
    cp dist/css/bootstrap.css.map /tmp/created-rails-app/app/assets/stylesheets/
    cp dist/css/bootstrap.css /tmp/created-rails-app/app/assets/stylesheets/
    str='   <script src="/bootstrap.bundle.js"></script>'
    sed -i '/\/head.*/i\ '"$str"'' /tmp/created-rails-app/app/views/layouts/application.html.erb

    cd /tmp/created-rails-app
    commit "Did bootstrap()"
}

# Basic setup for rails flash messages
flash() {
  cd /tmp/created-rails-app
  # TODO
}



upload() {
  # Temporary - for troubleshooting
  cd /tmp/created-rails-app
  git remote add bugDemo git@github.com:la-ruby/created-rails-app.git
  git checkout -b bugDemo
  git push -f bugDemo bugDemo
  git checkout main

  git clone git@github.com:la-ruby/created-rails-app.git /tmp/downloaded-rails-app
  cd /tmp/downloaded-rails-app/
  find -not -path "./.git/*" -not -name ".git" -delete
  rsync --stats -aP --exclude='.git/' --exclude='node_modules/*' /tmp/created-rails-app/ /tmp/downloaded-rails-app/ &>/dev/null

  git add --all
  git commit -m "Updates for $(date +%D)"
  git push origin main
}

commit() {
  git add --all &>/dev/null
  git commit -m "$1" &>/dev/null
}

main() {
  # Some Prereqs - git setup
  git config --global init.defaultBranch main
  git config --global user.email "example@example.com"
  git config --global user.name "Sam Bot"

  download
  generate
  repoint
  devise
  bootstrap
  flash
  upload
}

main
