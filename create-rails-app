#!/bin/bash

# Bash strict mode
set -e  # fail early
set -u  # warn about empty variables
set -x  # debug mode (during development)

# Variables
export CRA_ROOT="${HOME}/.cra"
export CRA_RAILS_VERSION="6-0-stable"
export CRA_REPO_DIR=${TRAVIS_BUILD_DIR}

# Some working directories
mkdir -p ${HOME}/.cra
mkdir -p ${HOME}/.cra/rails
mkdir -p ${HOME}/.cra/web-common-core

# Download some functions
(cd ${CRA_ROOT} && curl -sO https://raw.githubusercontent.com/la-ruby/insist-on-latest-ruby/master/insist_on_latest_ruby)
source ${CRA_ROOT}/insist_on_latest_ruby

# function to be run in any casem using TRAP
cra_cleanup() {
    rm -rf $CRA_ROOT
}

# Easier to just support one single version
insist_on_latest_ruby

# Generate rails application
git clone -b $CRA_RAILS_VERSION --single-branch https://github.com/rails/rails ${CRA_ROOT}/rails
(cd ${CRA_ROOT}/rails && bundle update --bundler | tail)
(cd ${CRA_ROOT}/rails && bundle install | tail)
(cd ${CRA_ROOT}/rails/railties/exe && bundle exec rails --version)
(cd ${CRA_ROOT}/rails/railties/exe && bundle exec rails new ${CRA_ROOT}/web-common-core --dev --database=postgresql --force | tail)
(cd ${CRA_ROOT}/web-common-core/ && bundle exec rails --version)

# latest bootstrap - https://gist.github.com/bazzel/2c64e2e5804077f9a61938a93ed54823
(cd ${CRA_ROOT}/web-common-core/ && yarn add bootstrap jquery popper.js expose-loader)
(cd ${CRA_ROOT}/web-common-core/ && yarn install --check-files)
(cd ${CRA_ROOT}/web-common-core/ && perl -pi.bak -e "s/extract_css: false/extract_css: true/" config/webpacker.yml)
s1=$'\n\nimport "bootstrap/dist/js/bootstrap";'
(cd ${CRA_ROOT}/web-common-core/ && echo "$s1" >> app/javascript/packs/application.js)
(cd ${CRA_ROOT}/web-common-core/ && echo '@import "~bootstrap/scss/bootstrap";' > app/javascript/packs/styles.scss)
(cd ${CRA_ROOT}/web-common-core/ && cp ${CRA_REPO_DIR}/expose-loader.txt ./)
(cd ${CRA_ROOT}/web-common-core/ && cp ${CRA_REPO_DIR}/stylesheet_pack_tag.txt ./)
(cd ${CRA_ROOT}/web-common-core/ && sed $'/module.exports = environment/{e cat expose-loader.txt\n}' config/webpack/environment.js) > ${CRA_ROOT}/web-common-core/config/webpack/environment.js.new
mv ${CRA_ROOT}/web-common-core/config/webpack/environment.js.new ${CRA_ROOT}/web-common-core/config/webpack/environment.js
(cd ${CRA_ROOT}/web-common-core/ && sed $'/javascript_pack_tag .application/{e cat stylesheet_pack_tag.txt\n}' app/views/layouts/application.html.erb) > ${CRA_ROOT}/web-common-core/app/views/layouts/application.html.erb.new
mv ${CRA_ROOT}/web-common-core/app/views/layouts/application.html.erb.new ${CRA_ROOT}/web-common-core/app/views/layouts/application.html.erb
(cd ${CRA_ROOT}/web-common-core/ && rm expose-loader.txt config/webpacker.yml.bak stylesheet_pack_tag.txt)
 
# Fix for bundle install error: The path `/home/travis/.cra/rails` does not exist.
revhash=$(cd ${CRA_ROOT}/rails && git rev-parse --short HEAD)
s1='gem .rails.,.*'
s2="gem 'rails', git: 'https:\/\/github.com\/rails\/rails.git', ref: '$revhash'"
(cd ${CRA_ROOT}/web-common-core/ && perl -pi.bak -e "s/$s1/$s2/" Gemfile)
(cd ${CRA_ROOT}/web-common-core/ && bundle install --jobs 3 --retry 3 --no-deployment)

# Upload artifacts
git clone https://github.com/la-ruby/web-common-core ${CRA_ROOT}/original_web-common-core
cd ${CRA_ROOT}/original_web-common-core && ((find . -path ./.git -prune -o -exec rm -rf {} \; &>/dev/null) || true)
rsync -rv --exclude=.git ${CRA_ROOT}/web-common-core/ ${CRA_ROOT}/original_web-common-core/ &>/dev/null
(cd ${CRA_ROOT}/original_web-common-core/; \
  git add --all; \
  git config user.name "Machine User 4"; \
  git config user.email $(echo 'fnz+znpuvar-hfre-4@fnz-jr.pbz' | tr '[A-Za-z]' '[N-ZA-Mn-za-m]'); \
  git commit -m "Newer rails ($(date +%m-%d-%Y))"; \
  git remote remove origin; \
  git remote add origin https://machine-user-4:${GIT_PASSWORD}@github.com/la-ruby/web-common-core.git; \
  git push origin HEAD )


# Housekeeping
trap cra_cleanup EXIT
